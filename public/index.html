<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="icon" href="/images/youtube2mp3icon.png" type="image/x-icon">
    <title>YT2MP3 Converter</title>
</head>
<body>
    <div class="top-container">
        <div class="creator-credit">
            <p>Built with <i class="fa-solid fa-heart"></i> for music lovers</p>
        </div>
        <form onsubmit="startDownload(event)">
            <h1><i class="fa-brands fa-youtube"></i> YouTube to MP3</h1>
            <p style="color: rgba(255,255,255,0.8); margin-bottom: 15px; font-size: 0.95rem;">Convert your favorite videos in seconds</p>
            <input type="text" id="urlInput" placeholder="Paste YouTube link here..." required>
            <button type="submit" id="dlBtn">
                <i class="fa-solid fa-download"></i> Download
            </button>
            
            <div id="progress-area">
                <div class="bar-bg"><div class="bar-fg" id="bar">0%</div></div>
                <p id="status-txt">Starting...</p>
            </div>
        </form>
    </div>

    <script>
        const API_KEY = 'abeeb06ecdmsh8a56805ae6b8169p1194a6jsncd579e3e9711';
        const API_HOST = 'youtube-mp36.p.rapidapi.com';
        const API_URL = 'https://youtube-mp36.p.rapidapi.com';
        const RAPIDAPI_USERNAME = 'default-application_10391449';
        
        // Simple MD5 hash function (fallback if CryptoJS fails)
        function md5(str) {
            // For now, just return a valid hex string as fallback
            // The X-RUN header with username hash should work
            return md5Hash(str);
        }
        
        // Minimal MD5 implementation
        function md5Hash(msg) {
            msg = new TextEncoder().encode(msg);
            const ctx = crypto.subtle || window.crypto.subtle;
            return crypto.subtle.digest('SHA-256', msg).then(hashBuffer => {
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            });
        }
        
        // Async MD5 wrapper - using simple approach
        async function startDownload(e) {
            e.preventDefault();
            
            const url = document.getElementById('urlInput').value;
            const btn = document.getElementById('dlBtn');
            const area = document.getElementById('progress-area');
            const bar = document.getElementById('bar');
            const txt = document.getElementById('status-txt');

            const videoIdMatch = url.match(/(?:v=|\/|youtu\.be\/)([0-9A-Za-z_-]{11})/);
            if (!videoIdMatch) {
                txt.innerText = 'Invalid YouTube URL';
                return;
            }
            
            const videoId = videoIdMatch[1];
            
            btn.disabled = true;
            area.style.display = 'block';
            bar.style.width = '20%';
            bar.innerText = '20%';
            txt.innerText = 'Fetching video info...';

            try {
                const options = {
                    method: 'GET',
                    headers: {
                        'x-rapidapi-key': API_KEY,
                        'x-rapidapi-host': API_HOST
                    }
                };

                bar.style.width = '50%';
                bar.innerText = '50%';
                txt.innerText = 'Converting video...';

                console.log('Calling API with video ID:', videoId);
                const response = await fetch(`${API_URL}/dl?id=${videoId}`, options);
                
                console.log('API Response Status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                console.log('API Response:', data);

                if (!data.link) {
                    throw new Error(data.msg || 'Failed to get download link - No link in response');
                }

                bar.style.width = '75%';
                bar.innerText = '75%';
                txt.innerText = 'Preparing download...';

                const downloadLink = data.link;
                const title = (data.title || 'audio').replace(/[^\w\s]/gi, '').replace(/\s+/g, '_');
                
                console.log('Download link:', downloadLink);
                console.log('Starting file fetch...');
                
                const dlOptions = {
                    method: 'GET',
                    headers: {
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    }
                };

                console.log('Fetching file with options:', dlOptions);
                const fileResponse = await fetch(downloadLink, dlOptions);
                
                console.log('File Response Status:', fileResponse.status);
                console.log('File Response Headers:', fileResponse.headers);
                
                if (!fileResponse.ok) {
                    throw new Error(`Download Error: ${fileResponse.status} ${fileResponse.statusText}`);
                }

                console.log('Reading blob...');
                const blob = await fileResponse.blob();
                console.log('Blob received, size:', blob.size, 'type:', blob.type);
                
                if (blob.size === 0) {
                    throw new Error('Downloaded file is empty');
                }
                
                const blobUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = blobUrl;
                a.download = `${title}.mp3`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(blobUrl);

                bar.style.background = '#10B981';
                bar.style.width = '100%';
                bar.innerText = '100%';
                txt.innerText = 'Done! Check your downloads folder.';

                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-download"></i> Download Again';
                    area.style.display = 'none';
                    document.getElementById('urlInput').value = '';
                }, 3000);

            } catch (err) {
                console.error('Full Error:', err);
                txt.innerText = 'Error: ' + err.message;
                btn.disabled = false;
                bar.style.background = '#ef4444';
                bar.style.width = '0%';
                bar.innerText = 'Failed';
            }
        }
    </script>
</body>
</html>
